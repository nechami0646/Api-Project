using TrickyTrayAPI.DTOs;
using TrickyTrayAPI.Models;
using TrickyTrayAPI.Repositories;
using static TrickyTrayAPI.DTOs.BuyerDto;

namespace TrickyTrayAPI.Services
{
    public class GiftService
    {
        private readonly GiftRepository _giftRepo;
        public GiftService(GiftRepository giftRepo)
        {
            _giftRepo = giftRepo;
        }

        public async Task<IEnumerable<GiftViewDto>> GetAllAsync()
        {
            var gifts = await _giftRepo.GetAllAsync();

            return gifts.Select(b => MapToViewDto(b));
        }

        public async Task<GiftViewDto?> GetByIdAsync(int id)
        {
            var gift = await _giftRepo.GetByIdAsync(id);

            return gift != null ? MapToViewDto(gift) : null;
        }
        private GiftViewDto MapToViewDto(Gift g)
        {
            return new GiftViewDto
            {
                Id = g.Id,
                Name = g.Name,
                Price = g.Price,
                ImageUrl = g.ImageUrl,
                DonorName = g.Donor?.Name ?? "תורם אנונימי"
            };
        }

        public async Task<GiftViewDto> CreateAsync(GiftCreateDto createDto)
        {

            var gift = new Gift
            {
                Name = createDto.Name,
                Description = createDto.Description,
                Price = createDto.Price,
                ImageUrl = createDto.ImageUrl,
                Category = createDto.Category,
                DonorId = createDto.DonorId
            };


            var savedGift = await _giftRepo.CreateAsync(gift);


            return MapToViewDto(savedGift);
        }

        public async Task<GiftViewDto?> UpdateAsync(int id, GiftUpdateDto updateDto)
        {
            var existingGift = await _giftRepo.GetByIdAsync(id);
            if (existingGift == null) return null;

            if (updateDto.Name != null) existingGift.Name = updateDto.Name;
            if (updateDto.Description != null) existingGift.Description = updateDto.Description;
            if (updateDto.Price != 0) existingGift.Price = updateDto.Price;
            if (updateDto.DonorId.HasValue) existingGift.DonorId = updateDto.DonorId.Value;
            if (updateDto.Category != null) existingGift.Category = updateDto.Category;
            if (updateDto.ImageUrl != null) existingGift.ImageUrl = updateDto.ImageUrl;


            var update = await _giftRepo.UpdateAsync(existingGift);
            return update != null ? MapToViewDto(update) : null;
        }

        public async Task<bool> DeleteAsync(int id)
        {
            return await _giftRepo.DeleteAsync(id);
        }

    }
}